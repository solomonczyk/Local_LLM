name: Hard Gates

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  hard-gates:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Generate reports
        run: |
          mkdir -p data/reports
          if [ -f tools/decision_dashboard.py ]; then
            python tools/decision_dashboard.py --out data/reports/dashboard_daily.md || true
          fi
          if [ -f tools/consilium_to_director.py ]; then
            python tools/consilium_to_director.py || true
          fi
          if [ -f tools/temporal_escalation.py ]; then
            python tools/temporal_escalation.py > data/reports/temporal_escalation.txt
          fi

      - name: Enforce hard gates
        run: |
          set -e
          VERDICT_FILE="data/reports/consilium_verdict.json"
          DASHBOARD_FILE="data/reports/dashboard_daily.md"

          # --- Human override via PR Approve (16B) ---
          APPROVALS=0
          if [ -n "${GITHUB_TOKEN:-}" ] && [ -n "${GITHUB_EVENT_PATH:-}" ]; then
            PR_NUMBER=$(python -c "import json; d=json.load(open('$GITHUB_EVENT_PATH','r',encoding='utf-8')); print(d.get('pull_request',{}).get('number',''))")
            REPO=$(python -c "import json; d=json.load(open('$GITHUB_EVENT_PATH','r',encoding='utf-8')); r=d.get('repository',{}); print(f\"{r.get('owner',{}).get('login','')}/{r.get('name','')}\")")
            if [ -n "$PR_NUMBER" ] && [ -n "$REPO" ]; then
              APPROVALS=$(python - <<'PY'
import json, os, urllib.request
token=os.environ.get("GITHUB_TOKEN","")
repo=os.environ.get("REPO","")
pr=os.environ.get("PR_NUMBER","")
url=f"https://api.github.com/repos/{repo}/pulls/{pr}/reviews?per_page=100"
req=urllib.request.Request(url, headers={
  "Authorization": f"Bearer {token}",
  "Accept": "application/vnd.github+json",
  "User-Agent": "hard-gates"
})
with urllib.request.urlopen(req, timeout=20) as resp:
  data=json.loads(resp.read().decode("utf-8"))
# count APPROVED reviews (simple rule)
approved=sum(1 for r in data if r.get("state")=="APPROVED")
print(approved)
PY
              )
            fi
          fi
          echo "HUMAN_OVERRIDE: approvals=$APPROVALS"
          OVERRIDE_ALLOWED=0
          if [ "${APPROVALS:-0}" -ge 1 ]; then
            OVERRIDE_ALLOWED=1
            echo "HUMAN_OVERRIDE: ALLOWED (>=1 APPROVE)"
          fi
          # --- end override ---

          verdict="unknown"
          if [ -f "$VERDICT_FILE" ]; then
            verdict=$(python <<'PY'
import json
d=json.load(open("data/reports/consilium_verdict.json","r",encoding="utf-8"))
r=d.get("director_result", d)
if isinstance(r,str):
    print(r)
elif isinstance(r,dict):
    print(r.get("decision") or r.get("recommended_action") or r.get("action") or (r.get("result",{}) or {}).get("decision") or "unknown")
else:
    print("unknown")
PY
)
          fi

          echo "HARD_GATES: verdict=$verdict"

          echo \"$verdict\" | grep -qi \"hold\" && {
            if [ \"$OVERRIDE_ALLOWED\" = \"1\" ]; then
              echo \"HARD_GATES_OVERRIDE: HOLD bypassed by human approval\"
            else
              echo \"HARD_GATES_FAIL: director verdict contains HOLD\"
              exit 1
            fi
          } || true

          if [ -f \"$DASHBOARD_FILE\" ]; then
            if grep -qi \"TEMPORAL_GATE: SOFT\" \"$DASHBOARD_FILE\"; then
              echo \"HARD_GATES_FAIL: TEMPORAL_GATE is SOFT\"
              exit 1
            fi
          fi

          echo \"HARD_GATES_PASS\"
