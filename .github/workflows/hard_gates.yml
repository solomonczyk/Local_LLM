name: Hard Gates

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  hard-gates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Generate reports
        run: |
          mkdir -p data/reports
          if [ -f tools/decision_dashboard.py ]; then
            python tools/decision_dashboard.py --out data/reports/dashboard_daily.md || true
          fi
          if [ -f tools/consilium_to_director.py ]; then
            python tools/consilium_to_director.py || true
          fi

      - name: Enforce hard gates
        run: |
          set -e
          VERDICT_FILE="data/reports/consilium_verdict.json"
          DASHBOARD_FILE="data/reports/dashboard_daily.md"

          verdict="unknown"
          if [ -f "$VERDICT_FILE" ]; then
            verdict=$(python - <<'PY'
import json
d=json.load(open("data/reports/consilium_verdict.json","r",encoding="utf-8"))
r=d.get("director_result", d)
if isinstance(r,str):
    print(r)
elif isinstance(r,dict):
    v = r.get("decision") or r.get("recommended_action") or r.get("action")
    if not v and isinstance(r.get("result"), dict):
        rr = r["result"]
        v = rr.get("decision") or rr.get("recommended_action") or rr.get("action")
    print(v or "unknown")
else:
    print("unknown")
PY
)
          fi

          echo "HARD_GATES: verdict=$verdict"

          echo "$verdict" | grep -qi "hold" && {
            echo "HARD_GATES_FAIL: director verdict contains HOLD"
            exit 1
          } || true

          if [ -f "$DASHBOARD_FILE" ]; then
            if grep -qi "TEMPORAL_GATE: SOFT" "$DASHBOARD_FILE"; then
              echo "HARD_GATES_FAIL: TEMPORAL_GATE is SOFT"
              exit 1
            fi
          fi

          echo "HARD_GATES_PASS"
