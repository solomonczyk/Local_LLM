name: Hard Gates

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  hard-gates:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Generate reports
        run: |
          mkdir -p data/reports
          if [ -f tools/decision_dashboard.py ]; then
            python tools/decision_dashboard.py --out data/reports/dashboard_daily.md || true
          fi
          if [ -f tools/consilium_to_director.py ]; then
            python tools/consilium_to_director.py || true
          fi
          if [ -f tools/temporal_escalation.py ]; then
            python tools/temporal_escalation.py > data/reports/temporal_escalation.txt
          fi

      - name: Enforce hard gates
        run: |
          set -e

          VERDICT_FILE="data/reports/consilium_verdict.json"
          DASHBOARD_FILE="data/reports/dashboard_daily.md"

          verdict="unknown"

          if [ -f "$VERDICT_FILE" ]; then
            verdict=$(python - <<'PY'
          import json
          d=json.load(open("data/reports/consilium_verdict.json"))
          print(d.get("decision","unknown"))
          PY
            )
          fi

          echo "HARD_GATES_VERDICT=$verdict"
