# Consilium — многоагентная система кодинга (local-first)

Consilium — это набор специализированных агентов, которые обсуждают задачу, готовят единый план/решение и (при необходимости) передают итог на финальную экспертизу Директору.

## 1) Принципы (что важно для результата)
- Local-first: по умолчанию всё выполняется локально (модель, память, индексация, инструменты).
- Минимум облака: Директор (GPT‑5.2) используется только в режиме `CRITICAL` или по ручному включению.
- Экономия токенов: детерминированные проверки/поиск/сбор контекста делаются инструментами; LLM получает только релевантный срез.
- Tool-use только с подтверждением: любые изменения файлов/системы — через UI‑кнопку approval (с dry‑run/preview).
- Безопасность и приватность: секреты/ключи/пароли не отправляются в облако; доступ к окружениям — по принципу минимальных прав.
- Разделение пайплайнов: RAG/KB (быстро даёт ценность) отдельно от SFT/LoRA (дороже и требует eval‑контроля).

## 2) Роли в Consilium (и зачем они нужны)
Роли сгруппированы так, чтобы закрывать весь цикл: разработка → тестирование → внедрение → поддержка.

### 2.1 CONSILIUM CORE (ядро)
- **Architect** — декомпозиция задачи, границы модулей, API‑контракты, масштабируемость, риски.
- **Maintainer/Reviewer** — ревью изменений, минимизация «лишних переписок», поддерживаемость, стиль, регрессии.
- **Director (cloud, GPT‑5.2)** — финальная экспертиза, но только при явном режиме/тумблере и с санитизацией контекста.

### 2.2 DOMAIN AGENTS (предметные агенты)
- **Dev (multi‑language)** — реализация фич/фиксов, генерация патчей, работа с кодовой базой.
- **QA** — тест‑план, минимальные репро, критерии готовности, запуск тестов, диагностика падений.
- **Security/Privacy** — политика секретов/доступов, аудит зависимостей, безопасные дефолты, ревью опасных действий.
- **UX (опционально)** — если задача про UI/flow/эргономику.
- **Data/ML (опционально)** — если задача про дообучение/датасеты/оценку моделей.

### 2.3 INFRA / CONTROL (инфра и контроль исполнения)
- **Tool/Execution** — выполняет tool‑действия (CRUD/search/shell/git/db) строго по approval, с dry‑run и проверками ожиданий.
- **DevOps/Release** — Docker/compose/nginx/порты, конфиги, healthchecks, логи, обновления и rollback.
- **Cost/Token Controller** — ограничивает контекст/токены, выбирает режим (FAST/STANDARD/CRITICAL), решает «нужен ли Director».
- **Memory/KB** — структура знаний, RAG/KB, версионирование заметок/правил, хранение локальных артефактов.

### 2.4 SUPPORT / FUTURE (поддержка и развитие)
- **Trainer/Curator** — подготовка датасетов, LoRA‑обучение, eval‑наборы, версия/хэши артефактов, экспорт в runtime‑форматы.

## 3) Режимы работы (против “токенного пожара”)
Рекомендуемые режимы (состав ролей настраивается):
- **FAST**: Dev + Reviewer (+ Tool/Cost по факту). Быстро, короткий контекст, минимум “дискуссий”.
- **STANDARD**: FAST + QA (+ Security по триггерам). Режим “делаем правильно”.
- **CRITICAL**: STANDARD + Architect + DevOps + (опционально Director). Для деплоя, безопасности, больших изменений.

Примечание: текущие пресеты режимов задаются в `agent_system/config.py` и должны быть синхронизированы с этим документом.

## 4) Smart routing (когда кого подключать)
- **Security**: секреты, сеть, аутентификация, внешние сервисы, права доступа, зависимости.
- **DevOps**: Docker/compose/nginx/SSL/порты/переменные окружения/CI.
- **QA**: любые изменения поведения, рефакторинг, новые инструменты, баг‑фиксы.
- **Architect**: изменения архитектуры, добавление новых подсистем (RAG/KB, training, новые backends).
- **Director**: только когда локального консилиума недостаточно и пользователь согласен на облако.

## 5) Политика облака (Director)
- По умолчанию Director **выключен**.
- В облако уходит только: краткое резюме консилиума + минимальные выдержки кода/диффа.
- Секреты/ключи/PII редактируются перед отправкой; `.env` и приватные ключи запрещены.

## 6) Профиль под текущее железо (GTX 1060 5GB)
Реалистичный “рабочий” состав:
- FAST: Dev (draft) + Reviewer
- STANDARD: + QA (+ Security по триггерам)
- CRITICAL: + Architect + DevOps (+ Director при необходимости)

